name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "microsoft"

      - name: Make Gradle executable
        run: chmod +x ./gradlew

      - name: Build
        run: ./gradlew clean build

      # -----------------------------
      # GitHub Release
      # -----------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: AttackCounter ${{ github.ref_name }}
          body_path: CHANGELOG.md
          files: build/libs/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------
      # Modrinth + CurseForge Publish
      # -----------------------------
      - name: Publish to Modrinth & CurseForge
        uses: Kir-Antipov/mc-publish@v3
        with:
          files: build/libs/*.jar

          # ===== Modrinth =====
          modrinth-id: attackcounter
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

          # ===== CurseForge =====
          #curseforge-id: 1412285
          #curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}

          # ===== Metadata =====
          name: AttackCounter ${{ github.ref_name }}
          version: ${{ github.ref_name }}
          version-type: release

          loaders: fabric
          game-versions: 1.21.5

          changelog: |
            Automated release.
            Full changelog:
            https://github.com/DraxonV1/AttackCounter/releases/tag/${{ github.ref_name }}
